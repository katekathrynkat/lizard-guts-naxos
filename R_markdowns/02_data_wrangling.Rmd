---
title: "Data wrangling"
subtitle: "From [Lizard guts: Naxos](https://github.com/katekathrynkat/lizard-guts-naxos)"
output:
  katereR::t_analysis
---

**Kate Culhane**, Dept. of Ecology, Evolution, and Marine Biology, UC Santa Barbara  
[kathrynculhane@ucsb.edu](kathrynculhane@ucsb.edu)
[<i class="fa fa-github"></i>](https://github.com/katekathrynkat/)
[<i class="fa fa-twitter"></i>](https://twitter.com/katekathrynkat/)

***

```{r setup, include=FALSE}
htmltools::tagList(rmarkdown::html_dependency_font_awesome())
knitr::opts_knit$set(root.dir='..')
knitr::opts_chunk$set(echo=TRUE, results='hold', warning=FALSE, message=FALSE,
                      fig.width=5, fig.height=3, rows.print=5)
```

<div class = "summary">

**SUMMARY**

Wrangling data 

</div>

***

**DEPENDENCIES**

```{r dependencies, class.source='fold-show'}

##### PACKAGES #####

library(tidyverse) # data manipulation & visualization
library(lubridate) # wrangling dates

##### DATA #####

# Stomach pump invert ID (all islands)
diet_raw <- read_csv('data_raw/field/diet_field.csv')

# Site metadata (Naxos)
meta_raw <- read_csv('data_raw/field/naxos_meta.csv')

# Vegetation quadrats (Naxos)
veg_raw <- read_csv('data_raw/field/naxos_veg.csv')

# Pitfall/sticky metadata (all islands)
prey_meta_raw <- read_csv('data_raw/field/prey_meta.csv',
                          col_types = "??cccc???????????????") # dates as chr

# Pitfall trap invert ID (all islands)
prey_p_raw <- read_csv('data_raw/field/prey_pitfall.csv')

# Sticky trap invert ID (all islands)
prey_s_raw <- read_csv('data_raw/field/prey_sticky.csv')

```

**OUTPUT FILES**

- **02_diet_inverts.csv**: Invertebrate counts by order from lizard stomach pumping samples
- **02_diet_matrix.csv**: Site by species matrix (diet data)
- **02_diet_veg.csv**: Vegetation counts from lizard stomach pumping samples
- **02_prey.csv**: Invertebrate counts by order from sticky and pitfall trap samples
- **02_prey_matrix.csv**: Site by species matrix (invert trap data)
- **02_prey_metadata.csv**: Metadata for sticky and pitfall trap samples
- **02_trap_veg**: Vegetation cover by life form from quadrats associated with invert traps

## Vegetation surveys

### Trap vegetation

- From trap metadata

```{r}

# Trap metadata
trap_veg <- prey_meta_raw %>% 
  filter(island == "Naxos") %>% 
  select(2, 8, 11:21)

write_csv(trap_veg, "output/02_trap_veg.csv", col_names = TRUE)

trap_veg

```

## Invertebrate trapping

### Metadata

- Calculated hours trap was open (33-35 hours)
- Calculated effort
  - Condition "GOOD" = 1
  - Condition "FLAW" = 0.5 
  - Condition "LOST" = 0

```{r}

# Trap metadata
prey_meta <- prey_meta_raw %>% 
  filter(island == "Naxos") %>% 
  left_join(prey_p_raw[c(2,4,31)], by = c("site", "trap")) %>% 
  left_join(prey_s_raw[c(2,4,24)], by = c("site", "trap")) %>% 
  mutate(comments_p = comments.y,
         comments_s = comments,
         comments = comments.x,
         set = dmy_hm(paste(date_set, time_set),
                      quiet = TRUE), # suppress warnings
         collected = dmy_hm(paste(date_coll, time_coll),
                            quiet = TRUE), # suppress warnings
         hours_open = as.numeric(collected - set)*24,
         pitfall_effort = case_when(
           pitfall_condition == "GOOD" ~ 1,
           pitfall_condition == "FLAW" ~ 0.5,
           pitfall_condition == "LOST" ~ 0),
         sticky_effort = case_when(
           sticky_condition == "GOOD" ~ 1,
           sticky_condition == "FLAW" ~ 0.5,
           sticky_condition == "LOST" ~ 0
         )) %>%
  select(site, set, collected, hours_open, crew, trap,
         pitfall_condition, pitfall_effort, sticky_condition, sticky_effort,
         comments, comments_p, comments_s)

write_csv(prey_meta, "output/02_prey_meta.csv", col_names = TRUE)

prey_meta

```

### Identification data

- Combined pitfall and sticky data
- Transformed from wide to long format

```{r}

# Pitfall trap data
prey_p <- prey_p_raw %>% 
  filter(island == "Naxos") %>% 
  mutate(trap_type = "pitfall",
         sample = paste0(site, "-P", trap)) %>% 
  select(-gecko, -lizard) %>% # remove columns for non-invertebrates
  pivot_longer(5:28, names_to = "order", values_to = "count")

# Sticky trap data
prey_s <- prey_s_raw %>% 
  filter(island == "Naxos") %>% 
  mutate(trap_type = "sticky",
         sample = paste0(site, "-S", trap)) %>% 
  select(-gecko) %>% # remove columns for non-invertebrates
  pivot_longer(5:22, names_to = "order", values_to = "count")

# All trap data
prey <- full_join(prey_p, prey_s) %>% 
  filter(count != 0) %>% 
  select(sample, site, trap, trap_type, order, count)

write_csv(prey, "output/02_prey.csv", col_names = TRUE)

prey

```

### Site by species matrix

```{r}

prey_matrix <- prey %>% 
  pivot_wider(names_from = order, values_from = count) %>% 
  replace(., is.na(.), 0)

write_csv(prey_matrix, "output/02_prey_matrix.csv", col_names = TRUE)

prey_matrix

```

## Lizard diet

### Inverts

- Filtered for invertebrates only
- Transformed from wide to long format

```{r}

diet_inverts <- diet_raw %>% 
  filter(island == "Naxos") %>% 
  select(-c(1, 33:43)) %>% 
  pivot_longer(4:31, names_to = "order", values_to = "count") %>% 
  filter(count != 0)

write_csv(diet_inverts, "output/02_diet_inverts.csv", col_names = TRUE)

diet_inverts

```

### Site by species matrix

```{r}

diet_matrix <- diet_inverts %>% 
  select(-date, -comments) %>% 
  pivot_wider(names_from = order, values_from = count) %>% 
  replace(., is.na(.), 0)

write_csv(diet_matrix, "output/02_diet_matrix.csv", col_names = TRUE)

diet_matrix

```

### Veg

```{r}

diet_veg <- diet_raw %>% 
  filter(island == "Naxos") %>% 
  select(-c(5:32)) %>% 
  pivot_longer(5:15, names_to = "order", values_to = "count") %>% 
  filter(count != 0)

write_csv(diet_veg, "output/02_diet_veg.csv", col_names = TRUE)

diet_veg

```

<br>
<br>
<br>

<details><summary>**Session info**</summary>
```{r session-info}
devtools::session_info()
```
</details>
